#!/bin/bash
set -ueo pipefail

DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

. "$DIR/../lib/env.bash"
. "$DIR/../lib/pull.bash"

echo "--- :anka: Cloning $BUILDKITE_PLUGIN_ANKA_VM_NAME to $job_image_name"

if [[ "${debug_mode:-off}" =~ (on) ]] ; then
  echo "$ anka clone $BUILDKITE_PLUGIN_ANKA_VM_NAME $job_image_name" >&2
fi
anka clone "$BUILDKITE_PLUGIN_ANKA_VM_NAME" "$job_image_name"

# Support for yaml command lists: https://github.com/chef/anka-buildkite-plugin/issues/4
O_IFS=$IFS
IFS=$'\n' 
BUILDKITE_COMMANDS=($(echo "$BUILDKITE_COMMAND"))
IFS=$O_IFS
for BUILDKITE_COMMAND in "${BUILDKITE_COMMANDS[@]}"; do  
  echo "+++ Executing $BUILDKITE_COMMAND in $job_image_name"
  COMMAND="anka run ${args[*]} bash -e -c \"${BUILDKITE_COMMAND}\""
  if [[ "${debug_mode:-off}" =~ (on) ]]; then echo "$ ${COMMAND}" >&2; fi
  eval "${COMMAND}"
done
